# -*- mode: ruby -*-
# vi: set ft=ruby :

# based on:
# http://tjheeta.github.io/2014/12/01/ansible-vagrant-multiple-nodes.html

require './inventory.rb'
# TODO: make hosts as global in a better way
hosts = @hosts

VAGRANTFILE_API_VERSION = "2"

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.ssh.forward_agent = true
  config.vm.box = "chef/centos-6.5"
  config.vm.provision :shell, path: "libselinux.sh"
  config.vm.boot_timeout = 90
  config.vm.graceful_halt_timeout = 10

  # 256MB RAM for all hosts
  config.vm.provider "virtualbox" do |vb|
    vb.customize ["modifyvm", :id, "--nictype1", "virtio"]
    vb.customize ["modifyvm", :id, "--memory", "256"]
  end

  # Creates "inventory" Hash including "all" group
  inventory = { "all" => [] }
  hosts.each do | host |
    inventory["all"].push(host[:name])

    if host.has_key?(:groups)
      host[:groups].each do | group |
        inventory["all"].push(host[:name]) unless inventory["all"].include?(host[:name])
        (inventory[group] ||= [] ) << host[:name] # force array creation
      end
    end

  end

  # setting up instance parameters
  hosts.each_with_index do | host, index |
    config.vm.define(host[:name]) do |config|
      config.vm.synced_folder ".", "/vagrant", disabled: true
      config.vm.hostname = "%s" % [ host[:name].to_s ]
      config.vm.network :private_network, ip: host[:ip].to_s

      if host[:forwards]
        host[:forwards].each do |guest_port,host_port|
          config.vm.network :forwarded_port, guest: guest_port, host: host_port, auto_correct: true
        end
      end

      if host[:sshport]
        host[:sshport].each do |guest_port,host_port|
          config.vm.network :forwarded_port, guest: guest_port, host: host_port, auto_correct: true, id: "ssh"
        end
      end

    config.vm.provider :virtualbox do |vb|
      # create disk if in Hash
      if host.has_key?(:disk)
        unless File.exist?(host[:disk].to_s)
          vb.customize ['createhd', '--filename', host[:disk].to_s, '--size', 500]
          vb.customize ['storageattach', :id, '--storagectl', 'IDE Controller', '--port', 1, '--device', 0, '--type', 'hdd', '--medium', host[:disk].to_s]
        end
      end

    config.vm.provision :ansible do |ansible|
      # ansible.verbose = "vvvv"
      ansible.playbook   = "code/tools/pubkeys.yml"
      ansible.groups     = inventory
      ansible.sudo       = true
      ansible.extra_vars = {
        ansible_ssh_user: 'vagrant',
        pub_file: '~/.ssh/id_rsa.pub',
        user: 'vagrant'
      }
    end

    # Copy autogenerated hosts to real enviro path
    config.vm.provision :host_shell do | host_shell |
      host_shell.inline = 'cp .vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory hosts'
        end
      end
    end
  end
end
